<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sourcerer Ludi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', Courier, monospace;
            background: #fff;
            color: #000;
            padding: 20px;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 4px solid #000;
            padding-bottom: 15px;
        }

        h1 {
            font-size: 2.8em;
            letter-spacing: 4px;
            color: #000;
            margin-bottom: 5px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .subtitle {
            color: #000;
            font-size: 1em;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .state-panel {
            background: #f0f0f0;
            border: 4px solid #000;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .state-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"] {
            padding: 8px;
            border: 3px solid #000;
            font-family: inherit;
            flex-grow: 1;
        }

        .saved-states-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .state-chip {
            padding: 4px 10px;
            background: #fff;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .state-chip button {
            padding: 1px 5px;
            border-width: 1px;
            font-size: 0.7em;
        }

        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .draw-options {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8em;
            border-left: 2px solid #000;
            padding-left: 15px;
            cursor: pointer;
        }

        .draw-options input { cursor: pointer; }

        button {
            background: #fff;
            color: #000;
            border: 3px solid #000;
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            font-weight: 900;
            transition: all 0.1s;
            text-transform: uppercase;
        }

        button:hover {
            background: #000;
            color: #fff;
            box-shadow: 4px 4px 0 #000;
            transform: translate(-2px, -2px);
        }

        button:active {
            transform: translate(0, 0);
            box-shadow: none;
        }

        .status {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1em;
            font-weight: bold;
            border: 2px solid #000;
            display: inline-block;
            padding: 5px 20px;
            left: 50%;
            position: relative;
            transform: translateX(-50%);
        }

        .hand {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            padding: 20px;
            min-height: 400px;
        }

        .card-container {
            position: relative;
            transition: margin 0.3s ease;
        }

        .card {
            background: #fff;
            border: 4px solid #000;
            padding: 15px;
            width: 200px;
            height: 280px;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 6px 6px 0 #000;
            user-select: none;
        }

        .card.is-flipped { background: #000; color: #fff; }
        .card.is-flipped .card-content { display: none; }
        .card-back-suit {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: 900;
            text-align: center;
            border: 2px solid #fff;
            padding: 10px;
            width: 85%;
        }
        .card.is-flipped .card-back-suit { display: block; }
        .card.selected { outline: 6px solid #aaa; outline-offset: 4px; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 3px solid #000;
        }

        .card-suit { font-weight: 900; font-size: 1.1em; }
        .card-label { font-weight: 900; font-size: 1.2em; margin-bottom: 10px; text-transform: uppercase; }
        .card-desc { font-size: 0.8em; flex-grow: 1; }

        .card-position {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            justify-content: center;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }

        .pos-dot { 
            width: 14px; 
            height: 14px; 
            background: #fff; 
            border: 2px solid #000; 
            border-radius: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .pos-dot:hover { background: #eee; }
        .pos-dot.active { background: #000; box-shadow: inset 0 0 0 2px #fff; }

        .card-menu {
            position: absolute;
            top: 0; left: 100%; margin-left: 15px; z-index: 100;
            background: #fff; border: 4px solid #000; padding: 5px;
            display: flex; flex-direction: column; gap: 5px; box-shadow: 4px 4px 0 #000; width: 160px;
        }
        .card-menu button { border: 1px solid #000; padding: 5px; font-size: 0.7em; text-align: left; width: 100%; color: #000; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); padding: 30px; overflow-y: auto; z-index: 1000;
        }
        .modal-content { max-width: 900px; margin: 0 auto; background: #fff; padding: 40px; border: 8px solid #000; }
        
        .stack-select-item {
            padding: 10px;
            border: 2px solid #000;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .stack-select-item:hover { background: #000; color: #fff; }

        /* Survey Styles */
        .survey-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin: 20px 0;
        }
        .survey-row {
            border: 4px solid #000;
            padding: 20px;
            background: #fafafa;
        }
        .survey-row-title {
            font-weight: 900;
            font-size: 1.2em;
            margin-bottom: 15px;
            text-transform: uppercase;
            display: block;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }
        .survey-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
        }
        .survey-option {
            padding: 12px;
            border: 2px solid #000;
            font-size: 0.85em;
            cursor: pointer;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.1s;
        }
        .survey-option:hover { background: #eee; }
        .survey-option.active { background: #000; color: #fff; border-color: #000; }
        .survey-option-label { font-weight: 900; text-transform: uppercase; font-size: 1em; }
        .survey-option-desc { font-size: 0.8em; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SOURCERER LUDI</h1>
            <div class="subtitle">A Map of Conscious Experience</div>
        </header>

        <div class="state-panel">
            <div class="state-controls">
                <input type="text" id="state-name" placeholder="NAME CURRENT CONFIGURATION...">
                <button onclick="game.saveState()">SAVE STATE</button>
            </div>
            <div id="saved-states-list" class="saved-states-list"></div>
        </div>

        <div class="controls">
            <button onclick="game.drawCard()" id="draw-btn">DRAW</button>
            <div class="draw-options">
                <input type="checkbox" id="reveal-draw"> <label for="reveal-draw">REVEAL ON DRAW</label>
            </div>
            <button onclick="game.autoWin()">COHERE</button>
            <button onclick="showSurveyModal()">SURVEY</button>
            <button onclick="game.newGame()">RESET</button>
        </div>

        <div class="status">
            <span id="hand-status">HAND: 0</span> | <span id="deck-status">DECK: 0</span>
        </div>

        <div id="hand" class="hand"></div>
    </div>

    <!-- Stack Modal -->
    <div id="stack-modal" class="modal">
        <div class="modal-content">
            <h2>STACK WITH...</h2>
            <div id="stack-list"></div>
            <button onclick="hideStackModal()" style="width:100%; margin-top:20px;">CANCEL</button>
        </div>
    </div>

    <!-- Survey Modal -->
    <div id="survey-modal" class="modal">
        <div class="modal-content">
            <h2>OBSERVATION SURVEY</h2>
            <p style="font-size: 0.8em; margin-bottom: 20px;">Identify your current coordinates. Unselected dimensions will remain unknown (face-down).</p>
            <div id="survey-grid" class="survey-grid"></div>
            <div style="display: flex; gap: 10px;">
                <button onclick="game.commitSurvey()" style="flex: 2; background: #000; color: #fff;">COMMIT STATE</button>
                <button onclick="hideSurveyModal()" style="flex: 1;">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        const LUDI_MODEL = {
            dimensions: [
                { id: 'I', suit: 'IDENTITY' }, { id: 'M', suit: 'MENTALITY' }, { id: 'F', suit: 'FOCUS' },
                { id: 'A', suit: 'AFFECT' }, { id: 'S', suit: 'SENSORY' }, { id: 'T', suit: 'TEMPORAL' }
            ],
            cards: [
                {dim: 'I', val: 0.00, label: 'Transcendent', desc: 'Self expanded beyond individual boundaries.'},
                {dim: 'I', val: 0.17, label: 'Disrupted', desc: 'Self sense is fragmented or depersonalized.'},
                {dim: 'I', val: 0.33, label: 'Social', desc: 'Self defined by relationships and roles.'},
                {dim: 'I', val: 0.50, label: 'Narrative', desc: 'Self as a coherent story over time.'},
                {dim: 'I', val: 0.67, label: 'Extended', desc: 'Self includes tools and environment.'},
                {dim: 'I', val: 0.83, label: 'Minimal', desc: 'Basic pre-reflective bodily presence.'},
                {dim: 'I', val: 1.00, label: 'Core', desc: 'Essential, unchanging sense of self.'},

                {dim: 'M', val: 0.00, label: 'Blank', desc: 'Complete absence of thought.'},
                {dim: 'M', val: 0.20, label: 'Quiet', desc: 'Minimal cognitive chatter.'},
                {dim: 'M', val: 0.40, label: 'Directed', desc: 'Linear, task-oriented thinking.'},
                {dim: 'M', val: 0.60, label: 'Associative', desc: 'Fluid, creative connections.'},
                {dim: 'M', val: 0.80, label: 'Hyper-Reflexive', desc: 'Intense self-monitoring thoughts.'},
                {dim: 'M', val: 1.00, label: 'Hyperlucid', desc: 'Every thought crystalline and vivid.'},

                {dim: 'F', val: 0.00, label: 'Scattered', desc: 'Complete distraction.'},
                {dim: 'F', val: 0.25, label: 'Divided', desc: 'Attending to multiple streams.'},
                {dim: 'F', val: 0.50, label: 'Baseline', desc: 'Normal attention focus.'},
                {dim: 'F', val: 0.75, label: 'Narrowed', desc: 'High concentration on one area.'},
                {dim: 'F', val: 1.00, label: 'Absorbed', desc: 'Total capture by a single point.'},

                {dim: 'A', val: -1.00, label: 'Anguish', desc: 'Intense suffering dominates.'},
                {dim: 'A', val: -0.50, label: 'Aversive', desc: 'Mildly unpleasant or resistant.'},
                {dim: 'A', val: 0.00, label: 'Neutral', desc: 'Equanimous; neither pleasant nor unpleasant.'},
                {dim: 'A', val: 0.50, label: 'Pleasant', desc: 'General sense of well-being.'},
                {dim: 'A', val: 1.00, label: 'Blissful', desc: 'Intense flourishing.'},

                {dim: 'S', val: 0.00, label: 'Numb', desc: 'Complete sensory muting.'},
                {dim: 'S', val: 0.25, label: 'Distant', desc: 'Muted or derealized perception.'},
                {dim: 'S', val: 0.50, label: 'Baseline', desc: 'Normal perception.'},
                {dim: 'S', val: 0.75, label: 'Vivid', desc: 'Enhanced sensory detail.'},
                {dim: 'S', val: 1.00, label: 'Hyperreal', desc: 'Everything impossibly vivid.'},

                {dim: 'T', val: 0.00, label: 'Timeless', desc: 'No time-sense or duration awareness.'},
                {dim: 'T', val: 0.25, label: 'Dilated', desc: 'Time feels slow and expanded.'},
                {dim: 'T', val: 0.50, label: 'Baseline', desc: 'Normal time-flow awareness.'},
                {dim: 'T', val: 0.75, label: 'Compressed', desc: 'Time feels accelerated.'},
                {dim: 'T', val: 1.00, label: 'Crystalline', desc: 'Perfect temporal certainty.'}
            ]
        };

        class LudiEngine {
            constructor() {
                this.hand = [];
                this.deck = [];
                this.selectedIndex = null;
                this.savedStates = JSON.parse(localStorage.getItem('ludi_v1_states') || '{}');
                this.surveyChoices = {}; // dimId -> val
                this.newGame();
            }

            newGame() {
                this.deck = [...LUDI_MODEL.cards].sort(() => Math.random() - 0.5);
                this.hand = [];
                this.selectedIndex = null;
                for (let i = 0; i < 6; i++) { this.drawCard(); }
                this.updateDisplay();
            }

            drawCard() {
                if (this.deck.length === 0) {
                    this.deck = [...LUDI_MODEL.cards].sort(() => Math.random() - 0.5);
                }
                
                const revealChecked = document.getElementById('reveal-draw')?.checked;
                const isFlipped = !revealChecked;

                const card = {
                    ...this.deck.pop(),
                    instanceId: Math.random().toString(36).substr(2, 9),
                    rotation: 0,
                    isFlipped: isFlipped,
                    stackedWith: null
                };
                this.hand.push(card);
                this.updateDisplay();
            }

            updateCard(id, updates) {
                this.hand = this.hand.map(c => (c.instanceId === id ? {...c, ...updates} : c));
                this.updateDisplay();
            }

            changeCardState(id, dim, val) {
                const newState = LUDI_MODEL.cards.find(c => c.dim === dim && c.val === val);
                if (newState) {
                    this.hand = this.hand.map(c => (c.instanceId === id ? {...c, ...newState} : c));
                    this.updateDisplay();
                }
            }

            autoWin() {
                const revealChecked = document.getElementById('reveal-draw')?.checked;
                const isFlipped = !revealChecked;

                this.hand = LUDI_MODEL.dimensions.map(d => {
                    const choices = LUDI_MODEL.cards.filter(c => c.dim === d.id);
                    return {
                        ...choices[Math.floor(Math.random() * choices.length)], 
                        instanceId: Math.random().toString(36).substr(2, 9),
                        rotation: 0, 
                        isFlipped: isFlipped, 
                        stackedWith: null
                    };
                });
                this.updateDisplay();
            }

            commitSurvey() {
                const finalCards = [];
                for (const dim of LUDI_MODEL.dimensions) {
                    const val = this.surveyChoices[dim.id];
                    
                    let template;
                    let isFlipped = false;

                    if (val !== undefined) {
                        // User chose a state
                        template = LUDI_MODEL.cards.find(c => c.dim === dim.id && c.val === val);
                    } else {
                        // Unanswered: pick random and hide
                        const options = LUDI_MODEL.cards.filter(c => c.dim === dim.id);
                        template = options[Math.floor(Math.random() * options.length)];
                        isFlipped = true;
                    }

                    finalCards.push({
                        ...template,
                        instanceId: Math.random().toString(36).substr(2, 9),
                        rotation: 0,
                        isFlipped: isFlipped,
                        stackedWith: null
                    });
                }
                this.hand = finalCards;
                this.updateDisplay();
                hideSurveyModal();
            }

            saveState() {
                const name = document.getElementById('state-name').value.trim();
                if (!name) return;
                const state = this.hand.map(c => ({ 
                    dim: c.dim, 
                    val: c.val, 
                    isFlipped: c.isFlipped, 
                    stackedWith: c.stackedWith,
                    rotation: c.rotation
                }));
                this.savedStates[name] = state;
                localStorage.setItem('ludi_v1_states', JSON.stringify(this.savedStates));
                document.getElementById('state-name').value = '';
                this.updateDisplay();
            }

            loadState(name) {
                const state = this.savedStates[name];
                this.hand = state.map(s => {
                    const template = LUDI_MODEL.cards.find(c => c.dim === s.dim && c.val === s.val);
                    return {
                        ...template,
                        instanceId: Math.random().toString(36).substr(2, 9),
                        rotation: s.rotation || 0,
                        isFlipped: s.isFlipped,
                        stackedWith: s.stackedWith || null
                    };
                });
                this.updateDisplay();
            }

            deleteState(name) {
                delete this.savedStates[name];
                localStorage.setItem('ludi_v1_states', JSON.stringify(this.savedStates));
                this.updateDisplay();
            }

            stackCard(childId, parentId) {
                this.hand = this.hand.map(c => c.instanceId === childId ? {...c, stackedWith: parentId} : c);
                this.selectedIndex = null;
                hideStackModal();
                this.updateDisplay();
            }

            unstackCard(id) {
                this.hand = this.hand.map(c => c.instanceId === id ? {...c, stackedWith: null} : c);
                this.updateDisplay();
            }

            selectCard(index) {
                this.selectedIndex = (this.selectedIndex === index) ? null : index;
                this.updateDisplay();
            }

            updateDisplay() {
                const handDiv = document.getElementById('hand');
                handDiv.innerHTML = '';
                
                this.hand.forEach((card, idx) => {
                    const dimInfo = LUDI_MODEL.dimensions.find(d => d.id === card.dim);
                    const container = document.createElement('div');
                    container.className = 'card-container';
                    
                    if (card.stackedWith) {
                        container.style.marginLeft = "-160px";
                        container.style.marginTop = "40px";
                        container.style.zIndex = idx + 10;
                    }

                    const el = document.createElement('div');
                    el.className = `card ${card.isFlipped ? 'is-flipped' : ''} ${this.selectedIndex === idx ? 'selected' : ''}`;
                    el.style.transform = `rotate(${card.rotation}deg)`;
                    el.onclick = (e) => { e.stopPropagation(); this.selectCard(idx); };

                    const allStatesInSuit = LUDI_MODEL.cards.filter(c => c.dim === card.dim);
                    const dots = allStatesInSuit.map(s => `
                        <div class="pos-dot ${s.val === card.val ? 'active' : ''}" 
                             title="${s.label}"
                             onclick="event.stopPropagation(); game.changeCardState('${card.instanceId}', '${card.dim}', ${s.val})">
                        </div>`).join('');

                    el.innerHTML = `
                        <div class="card-back-suit">${dimInfo.suit}</div>
                        <div class="card-content">
                            <div class="card-header">
                                <div class="card-suit">${dimInfo.suit}</div>
                                <div class="card-value">ID: ${card.dim}</div>
                            </div>
                            <div class="card-label">${card.label}</div>
                            <div class="card-desc">${card.desc}</div>
                            <div class="card-position">${dots}</div>
                        </div>
                    `;

                    if (this.selectedIndex === idx) {
                        const menu = document.createElement('div');
                        menu.className = 'card-menu';
                        menu.innerHTML = `
                            <button onclick="event.stopPropagation(); game.updateCard('${card.instanceId}', {isFlipped: !${card.isFlipped}})">FLIP</button>
                            <button onclick="event.stopPropagation(); game.updateCard('${card.instanceId}', {rotation: (game.hand[${idx}].rotation + 90) % 360})">ROTATE 90</button>
                            ${card.stackedWith ? 
                                `<button onclick="event.stopPropagation(); game.unstackCard('${card.instanceId}')">UNSTACK</button>` : 
                                `<button onclick="event.stopPropagation(); showStackModal('${card.instanceId}')">STACK...</button>`
                            }
                            <button onclick="event.stopPropagation(); game.hand.splice(${idx}, 1); game.updateDisplay();" style="color:red">DISCARD</button>
                            <button onclick="event.stopPropagation(); game.selectCard(null)">CLOSE</button>
                        `;
                        container.appendChild(menu);
                    }
                    container.appendChild(el);
                    handDiv.appendChild(container);
                });

                document.getElementById('hand-status').textContent = `HAND: ${this.hand.length}`;
                document.getElementById('deck-status').textContent = `DECK: ${this.deck.length}`;

                const stateList = document.getElementById('saved-states-list');
                stateList.innerHTML = '';
                Object.keys(this.savedStates).forEach(name => {
                    const chip = document.createElement('div');
                    chip.className = 'state-chip';
                    chip.innerHTML = `
                        <span>${name}</span>
                        <button onclick="game.loadState('${name}')">LOAD</button>
                        <button onclick="game.deleteState('${name}')" style="color:red">X</button>
                    `;
                    stateList.appendChild(chip);
                });
            }
        }

        const game = new LudiEngine();
        document.body.onclick = () => game.selectCard(null);

        function showStackModal(childId) {
            const list = document.getElementById('stack-list');
            list.innerHTML = '';
            game.hand.forEach(card => {
                if (card.instanceId !== childId && !card.stackedWith) {
                    const dimInfo = LUDI_MODEL.dimensions.find(d => d.id === card.dim);
                    const item = document.createElement('div');
                    item.className = 'stack-select-item';
                    item.innerHTML = `<span>${dimInfo.suit}</span> <span>${card.label}</span>`;
                    item.onclick = (e) => { e.stopPropagation(); game.stackCard(childId, card.instanceId); };
                    list.appendChild(item);
                }
            });
            document.getElementById('stack-modal').style.display = 'block';
        }

        function hideStackModal() { document.getElementById('stack-modal').style.display = 'none'; }

        function showSurveyModal() {
            const grid = document.getElementById('survey-grid');
            grid.innerHTML = '';
            
            LUDI_MODEL.dimensions.forEach(dim => {
                const row = document.createElement('div');
                row.className = 'survey-row';
                row.innerHTML = `<div class="survey-row-title">${dim.suit}</div>`;
                
                const optsCont = document.createElement('div');
                optsCont.className = 'survey-options';
                
                const cards = LUDI_MODEL.cards.filter(c => c.dim === dim.id);
                cards.forEach(c => {
                    const isActive = game.surveyChoices[dim.id] === c.val;
                    const opt = document.createElement('div');
                    opt.className = `survey-option ${isActive ? 'active' : ''}`;
                    opt.innerHTML = `
                        <div class="survey-option-label">${c.label}</div>
                        <div class="survey-option-desc">${c.desc}</div>
                    `;
                    opt.onclick = () => {
                        if (isActive) {
                            delete game.surveyChoices[dim.id];
                        } else {
                            game.surveyChoices[dim.id] = c.val;
                        }
                        showSurveyModal(); // Refresh UI
                    };
                    optsCont.appendChild(opt);
                });
                
                row.appendChild(optsCont);
                grid.appendChild(row);
            });

            document.getElementById('survey-modal').style.display = 'block';
        }

        function hideSurveyModal() { document.getElementById('survey-modal').style.display = 'none'; }
    </script>
</body>
</html>
